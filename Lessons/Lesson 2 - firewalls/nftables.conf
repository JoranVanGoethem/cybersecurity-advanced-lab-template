#!/usr/sbin/nft -f

flush ruleset

table inet firewall {
    #
    # Define named sets for easier rule management
    #
    sets {
        dmz = { type ipv4_addr; flags constant; elements = { 172.30.10.0/24 } }
        server = { type ipv4_addr; flags constant; elements = { 172.30.20.0/24 } }
        client = { type ipv4_addr; flags constant; elements = { 172.30.30.0/24 } }
        internet = { type ipv4_addr; flags constant; elements = { 192.168.62.0/24 } }
    }

    #
    # NAT table
    #
    table ip nat {
        chain prerouting {
            type nat hook prerouting priority 0;
        }

        chain postrouting {
            type nat hook postrouting priority 100;
            # NAT for internal -> internet
            ip saddr 172.30.0.0/16 oif "eth0" masquerade
        }
    }

    #
    # Filter table
    #
    chain input {
        type filter hook input priority 0;
        policy drop;

        # Allow loopback and established connections
        iif lo accept
        ct state established,related accept

        # Allow SSH to router (optional)
        tcp dport 22 ip saddr 172.30.0.0/16 accept

        # Allow ICMP (ping)
        ip protocol icmp accept

        # Drop everything else
    }

    chain forward {
        type filter hook forward priority 0;
        policy drop;

        # Always allow established/related
        ct state established,related accept

        # ---- DMZ RULES ----
        # DMZ -> Internet: allow HTTP
        ip saddr @dmz oif "eth0" tcp dport 80 accept

        # DMZ -> Server: deny (default drop)
        # Server -> DMZ: allow web updates (optional)
        ip saddr @server ip daddr @dmz tcp dport { 22, 80 } accept

        # ---- CLIENT RULES ----
        # Client -> Server: allow DNS + Database
        ip saddr @client ip daddr @server udp dport 53 accept
        ip saddr @client ip daddr @server tcp dport 3306 accept

        # Client -> DMZ: allow HTTP (to web)
        ip saddr @client ip daddr @dmz tcp dport 80 accept

        # Client -> Internet: allow everything (via NAT)
        ip saddr @client oif "eth0" accept

        # ---- SERVER RULES ----
        # Server -> Internet: allow updates
        ip saddr @server oif "eth0" accept

        # Default deny everything else
        drop
    }

    chain output {
        type filter hook output priority 0;
        policy accept;
    }
}
